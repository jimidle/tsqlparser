WAITFOR(
	    RECEIVE 
	    TOP(1)
	      message_type_name,
	      COALESCE(
		   (SELECT TOP(1) ConversationState
		    FROM CurrentConversations AS cc
		    WHERE cc.ConversationHandle = conversation_handle),
		   'NEW')
	      AS ConversationState,
	      COALESCE(
		  (SELECT TOP(1) ErrorCount
		   FROM CurrentConversations AS cc
		   WHERE cc.ConversationHandle = conversation_handle), 
		   0)
	      AS ConversationErrors,
	      CASE WHEN message_type_name = N'//Adventure-Works.com/Expenses/SubmitExpense'
		  THEN CAST(message_body AS XML).value(
			'declare namespace rpt = "http://Adventure-Works.com/schemas/expenseReport"
			   (/rpt:ExpenseReport/rpt:EmployeeID)[1]', 'nvarchar(20)')
		 ELSE NULL
	      END AS EmployeeID,
	      CASE WHEN message_type_name = N'//Adventure-Works.com/Expenses/SubmitExpense'
		  THEN CAST(message_body AS XML).query(
			'declare namespace rpt = "http://Adventure-Works.com/schemas/expenseReport" 
				     /rpt:ExpenseReport/rpt:ItemDetail')
	  ELSE NULL
      END AS ItemList
    FROM ExpenseQueue 
), TIMEOUT 60000 ;

